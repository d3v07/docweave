version: '3.8'

services:
  # ==========================================================================
  # Infrastructure Services
  # ==========================================================================

  neo4j:
    image: neo4j:5.17.0-enterprise
    container_name: docweave-neo4j
    hostname: neo4j
    ports:
      - "7474:7474"  # HTTP
      - "7687:7687"  # Bolt
    environment:
      - NEO4J_AUTH=neo4j/${NEO4J_PASSWORD}
      - NEO4J_ACCEPT_LICENSE_AGREEMENT=yes
      - NEO4J_PLUGINS=["apoc"]
      - NEO4J_apoc_export_file_enabled=true
      - NEO4J_apoc_import_file_enabled=true
      - NEO4J_apoc_import_file_use__neo4j__config=true
      - NEO4J_dbms_security_procedures_unrestricted=apoc.*
      - NEO4J_dbms_security_procedures_allowlist=apoc.*
      - NEO4J_dbms_memory_heap_initial__size=512m
      - NEO4J_dbms_memory_heap_max__size=2G
      - NEO4J_dbms_memory_pagecache_size=512m
    volumes:
      - neo4j_data:/data
      - neo4j_logs:/logs
      - neo4j_import:/var/lib/neo4j/import
      - neo4j_plugins:/plugins
    networks:
      - docweave-network
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:7474"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  zookeeper:
    image: confluentinc/cp-zookeeper:7.5.3
    container_name: docweave-zookeeper
    hostname: zookeeper
    ports:
      - "2181:2181"
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
      ZOOKEEPER_SYNC_LIMIT: 2
    volumes:
      - zookeeper_data:/var/lib/zookeeper/data
      - zookeeper_logs:/var/lib/zookeeper/log
    networks:
      - docweave-network
    healthcheck:
      test: ["CMD", "nc", "-z", "localhost", "2181"]
      interval: 10s
      timeout: 5s
      retries: 5

  kafka:
    image: confluentinc/cp-kafka:7.5.3
    container_name: docweave-kafka
    hostname: kafka
    ports:
      - "9092:9092"
      - "29092:29092"
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092,PLAINTEXT_HOST://localhost:29092
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 1
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 1
      KAFKA_GROUP_INITIAL_REBALANCE_DELAY_MS: 0
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: "false"
      KAFKA_NUM_PARTITIONS: 3
      KAFKA_DEFAULT_REPLICATION_FACTOR: 1
      KAFKA_LOG_RETENTION_HOURS: 168
      KAFKA_LOG_SEGMENT_BYTES: 1073741824
      KAFKA_LOG_RETENTION_CHECK_INTERVAL_MS: 300000
    volumes:
      - kafka_data:/var/lib/kafka/data
    networks:
      - docweave-network
    depends_on:
      zookeeper:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "kafka-broker-api-versions", "--bootstrap-server", "localhost:9092"]
      interval: 10s
      timeout: 10s
      retries: 5
      start_period: 30s

  kafka-init:
    image: confluentinc/cp-kafka:7.5.3
    container_name: docweave-kafka-init
    depends_on:
      kafka:
        condition: service_healthy
    networks:
      - docweave-network
    command: >
      bash -c "
        echo 'Creating Kafka topics...'
        kafka-topics --create --if-not-exists --bootstrap-server kafka:9092 --partitions 3 --replication-factor 1 --topic document-events
        kafka-topics --create --if-not-exists --bootstrap-server kafka:9092 --partitions 3 --replication-factor 1 --topic parsed-documents
        kafka-topics --create --if-not-exists --bootstrap-server kafka:9092 --partitions 3 --replication-factor 1 --topic extracted-claims
        kafka-topics --create --if-not-exists --bootstrap-server kafka:9092 --partitions 3 --replication-factor 1 --topic graph-updates
        kafka-topics --create --if-not-exists --bootstrap-server kafka:9092 --partitions 3 --replication-factor 1 --topic conflicts
        echo 'Topics created successfully!'
        kafka-topics --list --bootstrap-server kafka:9092
      "

  # ==========================================================================
  # Application Services
  # ==========================================================================

  ingestion-service:
    build:
      context: .
      dockerfile: services/ingestion/Dockerfile
    container_name: docweave-ingestion
    hostname: ingestion-service
    ports:
      - "8001:8001"
    environment:
      - NEO4J_URI=bolt://neo4j:7687
      - NEO4J_USER=neo4j
      - NEO4J_PASSWORD=${NEO4J_PASSWORD}
      - KAFKA_BOOTSTRAP_SERVERS=kafka:9092
      - INGESTION_SERVICE_PORT=8001
      - LOG_LEVEL=INFO
    volumes:
      - ./data:/app/data
      - ./shared:/app/shared
    networks:
      - docweave-network
    depends_on:
      neo4j:
        condition: service_healthy
      kafka:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8001/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  parser-service:
    build:
      context: .
      dockerfile: services/parser/Dockerfile
    container_name: docweave-parser
    hostname: parser-service
    ports:
      - "8002:8002"
    environment:
      - NEO4J_URI=bolt://neo4j:7687
      - NEO4J_USER=neo4j
      - NEO4J_PASSWORD=${NEO4J_PASSWORD}
      - KAFKA_BOOTSTRAP_SERVERS=kafka:9092
      - PARSER_SERVICE_PORT=8002
      - LOG_LEVEL=INFO
    volumes:
      - ./data:/app/data
      - ./shared:/app/shared
    networks:
      - docweave-network
    depends_on:
      neo4j:
        condition: service_healthy
      kafka:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8002/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  extractor-service:
    build:
      context: .
      dockerfile: services/extractor/Dockerfile
    container_name: docweave-extractor
    hostname: extractor-service
    ports:
      - "8003:8003"
    environment:
      - NEO4J_URI=bolt://neo4j:7687
      - NEO4J_USER=neo4j
      - NEO4J_PASSWORD=${NEO4J_PASSWORD}
      - KAFKA_BOOTSTRAP_SERVERS=kafka:9092
      - EXTRACTOR_SERVICE_PORT=8003
      - LOG_LEVEL=INFO
    volumes:
      - ./data:/app/data
      - ./shared:/app/shared
    networks:
      - docweave-network
    depends_on:
      neo4j:
        condition: service_healthy
      kafka:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8003/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  graph-updater-service:
    build:
      context: .
      dockerfile: services/graph-updater/Dockerfile
    container_name: docweave-graph-updater
    hostname: graph-updater-service
    ports:
      - "8004:8004"
    environment:
      - NEO4J_URI=bolt://neo4j:7687
      - NEO4J_USER=neo4j
      - NEO4J_PASSWORD=${NEO4J_PASSWORD}
      - KAFKA_BOOTSTRAP_SERVERS=kafka:9092
      - GRAPH_UPDATER_SERVICE_PORT=8004
      - LOG_LEVEL=INFO
    volumes:
      - ./data:/app/data
      - ./shared:/app/shared
    networks:
      - docweave-network
    depends_on:
      neo4j:
        condition: service_healthy
      kafka:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8004/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  query-service:
    build:
      context: .
      dockerfile: services/query-service/Dockerfile
    container_name: docweave-query
    hostname: query-service
    ports:
      - "8005:8005"
    environment:
      - NEO4J_URI=bolt://neo4j:7687
      - NEO4J_USER=neo4j
      - NEO4J_PASSWORD=${NEO4J_PASSWORD}
      - KAFKA_BOOTSTRAP_SERVERS=kafka:9092
      - QUERY_SERVICE_PORT=8005
      - LOG_LEVEL=INFO
    volumes:
      - ./data:/app/data
      - ./shared:/app/shared
    networks:
      - docweave-network
    depends_on:
      neo4j:
        condition: service_healthy
      kafka:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8005/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

# ==========================================================================
# Networks
# ==========================================================================
networks:
  docweave-network:
    driver: bridge
    name: docweave-network

# ==========================================================================
# Volumes
# ==========================================================================
volumes:
  neo4j_data:
    name: docweave-neo4j-data
  neo4j_logs:
    name: docweave-neo4j-logs
  neo4j_import:
    name: docweave-neo4j-import
  neo4j_plugins:
    name: docweave-neo4j-plugins
  zookeeper_data:
    name: docweave-zookeeper-data
  zookeeper_logs:
    name: docweave-zookeeper-logs
  kafka_data:
    name: docweave-kafka-data
